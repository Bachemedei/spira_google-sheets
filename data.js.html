<script>
/*
 *
 * ==========
 * DATE MODEL
 * ==========
 *
 * This holds all the information about the user and all template configuration information. 
 * Future versions of this program can add their artifact to the `templateData` object.
 *
 */


// This is a hack to reset the data, see below for more details.
function modelReset(){
   // model = new Store;

   // hack - this data is reset here, but the main location is in function Store() below
   model.userData = {
        currentUser: {
            url: '',
            userName: '',
            api_key: '',
        },
        currentUserRoleId: '',
        projects: [],
        projUserWNum: [],
        artifacts: [
          {name: 'requirements', id: 1},
          {name: 'testCases', id: 2},
          {name: 'incidents', id: 3},
          {name: 'releases', id: 4},
          {name: 'testRuns', id: 5},
          {name: 'tasks', id: 6},
          {name: 'testSteps', id: 7},
          {name: 'testSets', id: 8}
        ]
    };
}

function Store (){
    //All current user data is stored here and is cleared on disconnect or timeout
    //TODO Timeout function

    //this reset method throws an error on export **occasionally** for some reason, I believe it is a google app script bug of some kind, it would be my preferred way of resetting the model data. Suggest troubleshooting in next version.
    //this.resetAll = modelReset,
    this.userData = {
        currentUser: {
            url: '',
            userName: '',
            api_key: '',
        },
        currentUserRoleId: '',
        projects: [],
        projUserWNum: [],
        artifacts: [
          {name: 'requirements', id: 1},
          {name: 'testCases', id: 2},
          {name: 'incidents', id: 3},
          {name: 'releases', id: 4},
          {name: 'testRuns', id: 5},
          {name: 'tasks', id: 6},
          {name: 'testSteps', id: 7},
          {name: 'testSets', id: 8}
        ]
    },
    //Template data, can be used to populate all artifact templates
    this.templateData = {
        currentProjectName: '',
        currentProjectId: '',
        currentArtifactName: '',
        currentArtifactId: '',
        isTemplateLoaded: false,
        projectUsers: [],
        //Requirements template
        requirements: {
            identification: 'requirements',
            unsupported: ['L3:L400', 'M3:M400'],
            accessPermission: [1,2],
            standardTitleRange: 'A1:M1',
            customTitleRange: 'N1:AQ1',
            requireNumberFields: ['H'],
            editableRange: 'A3:AQ3',
            standardRange: 'A1:M2',
            customRange: 'N1:AQ2',
            customHeaders: 'N2:AQ2',
            customColumnLength: 'N3:N200',
            cellRange: 'A3:L3',
            customCellRange: 'N3:AQ3',
            cellRangeLength: 43,
            components: [],
            releases: [],
            dropdownColumnAssignments: [
                ['Version Number', 'd'],
                ['Type', 'e'],
                ['Importance', 'f'],
                ['Status', 'g'],
                ['Author', 'i'],
                ['Owner', 'j'],
                ['Components', 'k'],
                ['StatusId', 'm']
            ],
            dropdownUserColumnAssignments: [
                ['Author', 'i'],
                ['Owner', 'j']
            ],
            headings: [
                'Requirement Id', 
                'Requirement Name', 
                'Requirement Description', 
                'Release Version', 
                'Type', 
                'Importance', 
                'Status', 
                'Estimate', 
                'Author', 
                'Owner', 
                'Component', 
                'Linked Requirements \nCurrently not supported', 
                'Comment \nCurrently not supported', 
                'CUS-01', 'CUS-02', 'CUS-03', 'CUS-04', 'CUS-05', 'CUS-06', 'CUS-07', 'CUS-08', 'CUS-09', 'CUS-10', 'CUS-11', 'CUS-12', 'CUS-13', 'CUS-14', 'CUS-15', 'CUS-16', 'CUS-17', 'CUS-18', 'CUS-19', 'CUS-20', 'CUS-21', 'CUS-22', 'CUS-23', 'CUS-24', 'CUS-25', 'CUS-26', 'CUS-27', 'CUS-28', 'CUS-29', 'CUS-30'],
            JSON_headings: [
                "RequirementId", 
                "Name", 
                "Description", 
                "ReleaseVersionNumber", 
                "RequirementTypeId", 
                "ImportanceName", 
                "StatusName", 
                "EstimatePoints", 
                "AuthorName", 
                "OwnerName", 
                "ComponentName",
                "StatusId"],
            sizes: [
                [1, 100],
                [2, 250],
                [3, 350],
                [4, 250],
                [5, 100],
                [6, 100],
                [7, 100],
                [8, 100],
                [9, 100],
                [11, 200],
                [12, 200],
                [13, 400]
            ],
            dropdowns: {
                'Type': [
                    [-1, 'Package'],
                    [1, 'Need'],
                    [2, 'Feature'],
                    [3, 'Use Case'],
                    [4, 'User Story'],
                    [5, 'Quality'],
                    [6, 'Design Element']
                ],
                'Importance': [
                    [1, '1 - Critical'],
                    [2, '2 - High'],
                    [3, '3 - Medium'],
                    [4, '4 - Low']
                ],
                'Status': [
                    [1, 'Requested'],
                    [2, 'Planned'],
                    [3, 'In Progress'],
                    [4, 'Developed'],
                    [5, 'Accepted'],
                    [6, 'Rejected'],
                    [7, 'Under Review'],
                    [8, 'Obsolete'],
                    [9, 'Tested'],
                    [10, 'Completed']
                ]
            },
            customFields: []
            
            
        },
        releases: {
            unsupported: ['L3:L400', 'M3:M400'],
            accessPermission: [1,2],
            standardTitleRange: 'A1:L1',
            customTitleRange: 'M1:AP1',
            requireNumberFields: ['J','K'],
            editableRange: 'A3:AP3',
            standardRange: 'A1:L2',
            customRange: 'M1:AP2',
            customHeaders: 'M2:AP2',
            customColumnLength: 'M3:N200',
            cellRange: 'A3:L3',
            customCellRange: 'M3:AP3',
            cellRangeLength: 42,
            components: [],
            releases: [],
            dropdownColumnAssignments: [
                ['Status', 'e'],
                ['Type', 'f']
            ],
            dropdownUserColumnAssignments: [
                ['Creator', 'g']
            ],
            headings: [
            'Release Id', 
            'Release Name',
            'Release Description', 
            'Version Number', 
            'Status',
            'Type', 
            'Creator', 
            'Start Date',
            'End Date',
            'Resources',
            'Non Working Days',
            'Comment \nCurrently not supported', 
            'CUS-01', 'CUS-02', 'CUS-03', 'CUS-04', 'CUS-05', 'CUS-06', 'CUS-07', 'CUS-08', 'CUS-09', 'CUS-10', 
            'CUS-11', 'CUS-12', 'CUS-13', 'CUS-14', 'CUS-15', 'CUS-16', 'CUS-17', 'CUS-18', 'CUS-19', 'CUS-20', 
            'CUS-21', 'CUS-22', 'CUS-23', 'CUS-24', 'CUS-25', 'CUS-26', 'CUS-27', 'CUS-28', 'CUS-29', 'CUS-30'],
            JSON_headings: [
            "ReleaseId", 
            "Name", 
            "Description", 
            "VersionNumber",
            "ReleaseStatusId",
            "RequirementTypeId", 
            "CreatorId", 
            "StartDate", 
            "EndDate", 
            "ResourceCount", 
            "DaysNonWorking"],
            sizes: [
                [1, 100],
                [2, 250],
                [3, 350],
                [4, 250],
                [5, 100],
                [6, 100],
                [7, 100],
                [8, 100],
                [9, 100],
                [11, 200],
                [12, 200],
                [13, 400]
            ],
            dropdowns: {
                'Type': [
                    [1, 'Major Release'],
                    [2, 'Minor Release'],
                    [3, 'Iteration'],
                    [4, 'Phase']
                ],
                'Status': [
                    [1, 'Planned'],
                    [2, 'In Progress'], 
                    [3, 'Completed'],
                    [4, 'Closed'],
                    [5, 'Deferred'],
                    [6, 'Cancelled']
                ]
            },
            customFields: []
        },
        
        tasks : {
            identification: 'tasks',
            unsupported: [],
            accessPermission: [1,2],
            standardTitleRange: 'A1:L1',
            customTitleRange: 'M1:AQ1',
           requireNumberFields: ['J'],
            editableRange: 'A3:AP3',
            standardRange: 'A1:L2',
            customRange: 'M1:AQ2',
            customHeaders: 'M2:AQ2',
            customColumnLength: 'M3:N200',
            cellRange: 'A3:L3',
            customCellRange: 'M3:AQ3',
            cellRangeLength: 42,
            components: [],
            releases: [],
            headings: [
            'Task Id', 
            'Task Name',
            'Task Description', 
            'Release/Itteration',
            'Type', 
            'Priority',
            'Progress',
            'Owner',
            'Requirement',
            'Creator',
            'Status', 
            'Start Date',
            'End Date',
            'Folder'
      ],
                  JSON_headings: [
            "TaskId", 
            "Name", 
            "Description", 
            "ReleaseId", 
            "TaskTypeId", 
            "ImportanceId", 
            "TaskStatusId",
            "StatusName",
            'AuthorId',
            "OwnerId",
            "ComponentId",
            "EstimatePoints", 
            "AuthorName", 
            "OwnerName", 
            "ComponentName"
           
            ],
            
          dropdownColumnAssignments:  [
              ['Type', 'e'],
              ['Priority', 'f'],
              ['Status', 'l'],
              ['Owner', 'h'],
              ['Version Number', 'd'],
              ['Progress', 'g'],
              ['Status', 'k']
              
             
            ],
                 sizes: [
                [1, 100],
                [2, 250],
                [3, 350],
                [4, 250],
                [5, 250],
                [6, 100],
                [7, 100],
                [8, 100],
                [9, 100],
                [11, 200],
                [12, 200],
                [13, 400]
            ],
           
            dropdowns: {
                'Type': [
                    [1, 'Development'],
                    [2, 'Infrastructure'],
                    [3, 'Management'],
                    [4, 'Other'],
                    [5, 'Testing']
                ],
                'Status': [
                    [1, 'Not Started'],
                    [2, 'In Progress'], 
                    [4, 'Completed'],
                    [5, 'Blocked'],
                    [6, 'Deferred']
                ],
                
                'Priority': [
                    [1, '1 - Critical'],
                    [2, '2 - High'],
                    [3, '3 - Medium'],
                    [4, '4 - Low']
                
                
                ],
                
                'Progress': [
                    [1, 'Not Started'],
                    [2, 'Starting Late'],
                    [3, 'On Schedule'],
                    [4, 'Running Late'],
                    [5, 'Completed']
                
                
                ],
                
               
       
            },

                
            customFields: []
   }
   
        
    }
}

//model becomes a new instance of the data store preserving the immutability of the primary data object.
let model = new Data;

let params = {
    fieldType: {
        int: 1,
        num: 2,                                                           
        bool: 3,
        text: 4,
        date: 5,
        drop: 6,
        user: 7,
        component: 8,
        release: 9,
        arr: 10
    },
    artifacts: [
        {field: 'requirements', name: 'Requirements', id: 1},
        {field: 'testCases', name: 'Test Cases', id: 2, disabled: true},
        {field: 'incidents', name: 'Incidents', id: 3, disabled: true},
        {field: 'releases', name: 'Releases', id: 4, disabled: true},
        {field: 'testRuns', name: 'Test Runs', id: 5, disabled: true},
        {field: 'tasks', name: 'Tasks', id: 6, disabled: true},
        {field: 'testSteps', name: 'Test Steps', id: 7, disabled: true, hidden: true},
        {field: 'testSets', name: 'Test Sets', id: 8, disabled: true}
    ]
};

function Data() {

    this.user = {
        url: '',
        userName: '',
        api_key: '',
        roleId: 1, //TODO this is wrong and should eventually be fixed to limit what user can create or edit client side
    };

    this.projects = [];

    this.currentProject = '';
    this.currentProjectComponents = [];
    this.currentProjectReleases = [];
    this.currentProjectUsers = [];
    
    this.currentArtifact = '';

    this.getRequest = {
        components: false,
        customs: false,
        releases: false,
        users: false
    };
    this.getSuccess = {
        components: false,
        customs: false,
        releases: false,
        users: false
    };
    
    this.isTemplateLoaded = false;

    this.artifactData = '';

    this.sheetRanges = {
        // TODO MAKE DYNAMIC - these are for requirements
        unsupported: ['L3:L400', 'M3:M400'],
        accessPermission: [1,2],
        standardTitleRange: 'A1:M1',
        customTitleRange: 'N1:AQ1',
        editableRange: 'A3:AQ3',
        standardRange: 'A1:M2',
        customRange: 'N1:AQ2',
        customHeaders: 'N2:AQ2',
        customColumnLength: 'N3:N200',
        cellRange: 'A3:L3',
        customCellRange: 'N3:AQ3',
        cellRangeLength: 43,
    };

    this.isTemplateLoaded = false;
    this.template = {
        accessPermission: '' //TODO - not hooked up or likely working correctly
    };
};

let fields = {
    requirements: {
        fields: [
            {field: "RequirementId", name: "Requirement ID", type: params.fieldType.int, col: 0, width: 100},
            {field: "Name", name: "Requirement Name", type: params.fieldType.text, col: 1, width: 250},
            {field: "Description", name: "Requirement Description", type: params.fieldType.text, col: 2, width: 350},
            {field: "ReleaseVersionNumber", name: "Release Version", type: params.fieldType.release, col: 3, width: 250},
            {field: "RequirementTypeId", name: "Type", type: params.fieldType.drop, col: 4, width: 100,
                values: [
                    {id: -1, name: "Package"},
                    {id: 1, name: "Need"},
                    {id: 2, name: "Feature"},
                    {id: 3, name: "Use Case"},
                    {id: 4, name: "User Story"},
                    {id: 5, name: "Quality"},
                    {id: 6, name: "Design Elemen"}
                ]
            },
            {field: "ImportanceName", name: "Importance", type: params.fieldType.drop, col: 5, width: 100, 
                values: [
                    {id: 1, name: "1 -Critical"},
                    {id: 2, name: "2 -High"},
                    {id: 3, name: "3 -Medium"},
                    {id: 4, name: "4 -Low"}
                ]
            },
            {field: "StatusName", name: "Status", type: params.fieldType.drop, col: 6, width: 100, 
                values: [
                    {id: 1, name: "Requested"},
                    {id: 2, name: "Planned"},
                    {id: 3, name: "In Progress"},
                    {id: 4, name: "Developed"},
                    {id: 5, name: "Accepted"},
                    {id: 6, name: "Rejected"},
                    {id: 7, name: "Under Review"},
                    {id: 8, name: "Obsolete"},
                    {id: 9, name: "Tested"},
                    {id: 10, name: "Completed"}
                ]
            },
            {field: "EstimatePoints", name: "Estimate", type: params.fieldType.num, col: 7, width: 100},
            {field: "AuthorName", name: "Author", type: params.fieldType.user, col: 8, width: 100},
            {field: "OwnerName", name: "Owner", type: params.fieldType.user, col: 9, width: 100},
            {field: "ComponentName", name: "Component", type: params.fieldType.component, col: 10, width: 200},
            {field: "LinkedRequirementIds", name: "Linked Requirements \nCurrently not supported", type: params.fieldType.arr, col: 11, unsupported: true},
            {field: "StatusId", name: "Status ID", type: params.fieldType.drop, col: 12}, //not sure this is needed
            {field: "Comment", name: "Comment \nCurrently not supported", type: params.fieldType.text, col: 13, width: 400, unsupported: true},
            
             
        ],
    }
};

function createSheetRange (startCol, endCol, startRow, endRow) {

    var colStart = toColumnName(startCol),
        colEnd = toColumnName(endCol),
        rowStart = startRow,
        rowEnd = endRow;
    return colStart + rowStart + ":" + colEnd + rowEnd;
}

/**
 * Takes a positive integer and returns the corresponding column name.
 * from http://cwestblog.com/2013/09/05/javascript-snippet-convert-number-to-column-name/
 * @param {number} num  The positive integer to convert to a column name.
 * @return {string}  The column name.
 */
 function toColumnName(num) {
  for (var ret = '', a = 1, b = 26; (num -= a) >= 0; a = b, b *= 26) {
    ret = String.fromCharCode(parseInt((num % b) / a) + 65) + ret;
  }
  return ret;
}


</script>