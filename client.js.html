<script>
// The .js.html files will be bundled inline into the .html file on load


/*
 *
 * =================================
 * UTILITIES & CROSS PANEL FUNCTIONS
 * =================================
 *
 */

// for dev mode only - comment out or set to false to disable any UI dev features
let devMode = true;

(function () {
    setDevStuff();
})();

function setDevStuff () {
    if (devMode) {
        $("#btn-dev").removeClass("hidden");
        
        model.userData.currentUser.url = "https://demo.spiraservice.net/oluwatoni";
        model.userData.currentUser.userName = "administrator";
        model.userData.currentUser.api_key = "{8323528B-5A45-4FD9-867C-82BF7194EF4F}";
    }
}

// panel: string. suffix for items to act on (eg if id = panel-help, choice = "help")
function panelToggle (panel) {
    panelId = "#panel-" + panel;
    $(panelId).toggleClass("offscreen");
}
function hidePanel (panel) {
    panelId = "#panel-" + panel;
    $(panelId).addClass("offscreen");
}
function showPanel (panel) {
    panelId = "#panel-" + panel;
    $(panelId).removeClass("offscreen");
}

function showLoadingSpinner () {
    $('#loader').removeClass('hidden');
}
function hideLoadingSpinner () {
    $('#loader').addClass('hidden');
}


function clearAddonData () {
    //clear spreadsheet, model
    clearSheet();
    modelReset();
}

// shouldClear: optional bool to check
function clearSheet (shouldClear) {
    var shouldClearToUse = typeof shouldClear !== 'undefined' ? shouldClear : true;
    if (shouldClearToUse) google.script.run.clearAll();
}

function resetSidebar () {
    clearAuthForm();
    
    // hide other panels, so login page is visible
    $(".panel:not(#panel-auth)").addClass("offscreen");
    
    // disable template button and artifact dropdown
    $("#btn-template, #select-artifact").prop("disabled", true);

    // reset artifact dropdown to 'Select an Artifact'
    $("#select-artifact option[value='Select an Artifact']").attr("selected", "selected");
    
    // reset anything required if in devmode
    setDevStuff();
}









/*
 *
 * ============
 * LOGIN SCREEN
 * ============
 *
 */

function getAuthDetails () {
    // get user data from input fields and store in user data object
    model.userData.currentUser.url = $("#input-url").val();
    model.userData.currentUser.userName = $("#input-userName").val();
    model.userData.currentUser.api_key = btoa("&api-key=" + encodeURIComponent($("#input-password").val()));
}

// fill in mock values for easy log in development, enable dev button
function setAuthDetails () {
    $('#input-url').val(model.userData.currentUser.url);
    $('#input-userName').val(model.userData.currentUser.userName);
    $('#input-password').val(model.userData.currentUser.api_key);
}

function clearAuthForm () {
    //clear input field values
    $('#input-url, #input-userName, #input-password').val('');
}

function loginAttempt () {
    getAuthDetails();
    login();
}

// login function that starts the intial data creation
function login() {    
    showLoadingSpinner();

    // call server side function to get projects
    // also serves as authentication check, if the user credentials aren't correct it will throw a network error
    google.script.run.withSuccessHandler(populateProjects).withFailureHandler(errorNetwork).getProjects(model.userData.currentUser);
}

// kick off prepping and showing main panel
function populateProjects (projects) {

    // take projects data from Spira API call, strip out unwanted fields, add to data model
    let pairedDownProjectsData = projects.map(function(project) {
        let result = {
            id: project.ProjectId,
            name: project.Name
        };
        return result;
    });
    
    // now add paired down project array to data store
    model.userData.projects = pairedDownProjectsData;
    
    // get UI logic ready for main panel
    showMainPanel();
}









/*
 *
 * ===========
 * MAIN SCREEN
 * ===========
 *
 */
 
function showMainPanel () {
    // displays the current logged in user name
    $('#js--loggedInAs').html('Logged in as: ' + model.userData.currentUser.userName);
    
    setProjectsDropdown();
    showPanel("main");
    hideLoadingSpinner();

    // server side 'slide up' pop-up window (aka 'toast') notifying user on success
    google.script.run.success('Projects loaded');

}

function setProjectsDropdown () {
    // add default "select" option to top of project array
    var projects = JSON.parse(JSON.stringify(model.userData.projects));
    var selectAProject = {id: 0, name: "Select a project"};
    projects.unshift(selectAProject);

    // clear project dropdown
    $("#select-project").html('');
    
    // add all projects to the dropdown
    $.each(projects, function (i, item) {
        $("#select-project").append($("<option>", { 
            value: item.id,
            text: item.name 
        }));
    });
}


function logoutAttempt () {
    //warn user that all tab data will be lost. Returns true or false
    google.script.run.withSuccessHandler(logout).warn('All data on current tab will be deleted. Continue?');
}
//gets a true or false value promise from google
function logout (shouldLogout) {
    if (shouldLogout) {
        clearAddonData();
        resetSidebar();
    }
}

function createTemplateAttempt() {   
    //warn the user data will be erased
    google.script.run.withSuccessHandler(createTemplate).warn('All data on current tab will be replaced. Continue?');
}
function createTemplate (shouldClearForm) {
    if (shouldClearForm) {
        clearSheet();
        
        //set artifact equal to the artifact from the dropdown
        //TODO: this does nothing and should be deleted as part of refactor
        var artifact = $("#select-artifact").value;
      
        projectAndArtifactSetter();   
    }
}

function clearSheetAttempt () {
    //warn that data will be erased
    google.script.run.withSuccessHandler(clearSheet).warn('All data on current tab will be deleted. Continue?');
};








/*
 *
 * ===========
 * HELP SCREEN
 * ===========
 *
 */

// choice: string. suffix for items to select (eg if id = help-section-fields, choice = "fields")
function showChosenHelpSection (choice) {
    // hide all sections and then only show the one the user wants
    $(".help-section").addClass("hidden");
    $("#help-section-" + choice).removeClass("hidden");
    
    // set all buttons back to normal, then highlight one just clicked
    $(".btn-help").removeClass("create");
    $("#btn-help-" + choice).addClass("create");
}














$('#js--import').click(function() {
    //this can be reimplemented in future versions but all code related to importing artifact data is commented out.

    // if (model.templateData.isTemplateLoaded) {
    //     google.script.run.withSuccessHandler(importSuccess).withFailureHandler(errorNetwork).importer(model.userData.currentUser);
    // } else {
    //     google.script.run.noTemplate();
    // }

    // function importSuccess() {
    //     google.script.run.success('Data loaded successfully.');
    // }

});

$('#js--export').click(function() {
    //check that template is loaded
    //edge case check.
    if (model.templateData.isTemplateLoaded) {
        
        showLoadingSpinner();
        
        //call export function
        google.script.run.withFailureHandler(errorImpExp).withSuccessHandler(exportSuccess).exporter(model);
    } else {
        //if no template popup a warning
        google.script.run.noTemplate();
    }

    function exportSuccess(data) {
  
        //Array holds the error responses
        let errorArr = data[1];

        //if errors present
        if (errorArr.length) {
            //log all errors to the console.
            errorArr.map(function(error) {
                console.log(error);
            })
        }
        
        hideLoadingSpinner();
        
        //runs the export success function, passes a boolean flag, if there are errors the flag is true.
        google.script.run.exportSuccess(data[0]);

    }
});

$('#btn-save').click(function() {
    //check to see if there is a template present
    //edge case check
    if (model.templateData.isTemplateLoaded) {

        showLoadingSpinner();
        
        //call save function
        google.script.run.withFailureHandler(errorUnknown).withSuccessHandler(saveSuccess).save();
    } else {
        //if no template popup a warning
        google.script.run.noTemplate();
    }

    function saveSuccess(bool) {
        // toggle spinner off on yes or no from popup dialog
        $('#loader').toggleClass('hidden');
        
        if(bool){
            //notify on success
            google.script.run.success('Sheet saved in new tab.');
        }
    }
});

//handles changing project dropdown - what should be enabled or disabled
$('#select-project').change(function(e) {
    //if the project field has not been selected all other selected buttons are disabled
    if (e.target.value == 0) {
        $("#select-artifact, #btn-template").prop('disabled', true);
    } else {
        //enable artifacts dropdown
        $('#select-artifact').prop('disabled', false);

        //if artifact already selected, also enable the template button
        if ($('#select-artifact option:selected').val() != 0) {
            $('#btn-template').prop('disabled', false)
        }
    }
});

//handles enabling the template button if the artifact drop down is properly selected.
$('#select-artifact').change(function(e) {
    if (e.target.value === 'Select an Artifact') {
        $('#btn-template').prop('disabled', true);
    } else {
        $('#btn-template').prop('disabled', false);
    }
});









/*
 *
 * =================
 * UTILITY FUNCTIONS
 * =================
 *
 * These scripts build the model for the selected artifact and project
 * Error pop-ups are also located here
 *
 */









// sets the model data based on the chosen project and artifact
// called when the template function is launched
function projectAndArtifactSetter() {
    // store dropdown values
    let projectDropdownVal = $('#select-project option:selected').val();
    let artifactDropdownVal = $('#select-artifact option:selected').val();

    // filter the project and artifact lists to those chosen 
    let artifactSelected = model.userData.artifacts.filter(function(artifact) {
        return artifact.name == artifactDropdownVal
    })[0];
    let projectSelected = model.userData.projects.filter(function(project) {
        return project[1] == projectDropdownVal
    })[0];
    
    // set the template data to the filtered values
    model.templateData.currentArtifactName = artifactSelected.name;
    model.templateData.currentArtifactId = artifactSelected.id;
    
    model.templateData.currentProjectName = projectSelected.name;
    model.templateData.currentProjectID = projectSelected.id;

    // get all relevant information for chosen project and artifact
    updateData();
}

//This function updates the user info for the selected project and artifact.
//this function also calls the create template function after all data has been properly received
//this function will throw an error if the user does not have the proper permissions
function updateData() {

    showLoadingSpinner();

    //call google function to load project users data
    
    google.script.run.withSuccessHandler(userSuccess).withFailureHandler(errorNetwork).getUsers(model.userData.currentUser, model.templateData.currentProjectId)
    
    //parses user data on successful fetch
    function userSuccess(users) {
        //clear old values
        model.userData.projUserWNum = [];
        //map through user obj and assign names
        users.map(user => {
      
            let num = user.UserId;
            let first = user.FirstName;
            let last = user.LastName;
            let full = '';
            //concat user name data into proper format
            //check to see if middle name exists
            if (user.MiddleInitial) {
                let middle = user.MiddleInitial;
                full = first + ' ' + middle + ' ' + last;
            } else {
                full = first + ' ' + last;
             
            }
            
            //add name and id to data model [id, name]
            model.userData.projUserWNum.push([num, full]);

            //populate user dropdowns model arrays into the templateData for [id, name]
            model.templateData.projectUsers.push([num, full]);

            //Log current user role id to current user data object
            if (model.userData.currentUser.userName == user.UserName) {
                //TODO access customized role id to lock out users without access
                //currently the app will allow any user to attempt to post any artifact to a project they have access to.
                //model.userData.currentUserRoleId = user.ProjectRoleId

                //*******all access granted***********
                model.userData.currentUserRoleId = 1;
            }
            
        })

        //check user role against allowed user roles
        //if permission is correct continue along the callback chain
        if (model.templateData.requirements.accessPermission.includes(model.userData.currentUserRoleId)) {
            getCustomFields();
           

        //if permission is not correct pop up a warning and do nothing
        } else {
       
            google.script.run.okWarn('You do not have the correct permissions to access this artifact');
            
            hideLoadingSpinner();
        }
    }
    
    //get all custom fields
    function getCustomFields() {
 
        //call server side fetch for project custom fields
        google.script.run.withSuccessHandler(customSuccess).withFailureHandler(errorNetwork)
            .getCustoms(model.userData.currentUser, model.templateData.currentProjectNumber, model.templateData.currentArtifactId);

        //called on successful custom field fetch
        function customSuccess(data) {
            //assign unparsed data to data object
            //these values are parsed later depending on function needs
            model.templateData.requirements.customFields = data;
             console.log('Hello World');
             getOwner();
        }
    }

  function getOwner(){
    //call server for username values
    google.script.run.withSuccessHandler(authorSuccess).withFailureHandler(errorNetwork).getUsers(model.userData.currentUser, model.templateData.currentProjectNumber);

    function authorSuccess(data) {
    
    var arr = [];
    //map through Author data object
    data.map(function(data){
    // push data onto array
    arr.push([data.AuthorId, data.FullName])
    })
    
    //assign values to dropdown data 
    model.templateData.requirements.dropdowns['Owner'] = arr;
    //This method can be used to work around requirement hardcodings, a new artifact array must be created in store.js
    model.templateData.tasks.dropdowns['Owner'] = arr;
    model.templateData.requirements.dropdowns['Author'] = arr;
    
    
    getComponentsValues();
    
    google.script.run.success('User data loaded');
    
    
    
    }

    
    
    
    }
    
    
    
    
    
    

    function getComponentsValues() {
        google.script.run.withSuccessHandler(componentSuccess).withFailureHandler(errorNetwork).getComponents(model.userData.currentUser, model.templateData.currentProjectNumber);

        function componentSuccess(data) {
            var arr = [];
            //map through component data object
            data.map(function(data) {
                //push id and name into array
                arr.push([data.ComponentId, data.FullName])
            })
            //assign array to data model
            model.templateData.requirements.components = arr;

            //assign values to dropdown data
            model.templateData.requirements.dropdowns['Components'] = arr;


            getReleasesValues();
        }
    }

    function getReleasesValues() {
        google.script.run.withSuccessHandler(releaseSuccess).withFailureHandler(errorNetwork).getReleases(model.userData.currentUser, model.templateData.currentProjectNumber);
      
   
        function releaseSuccess(data) {

            var arr = [];
            //map through release data object
            data.map(function(data) {
                //collect id and name
                arr.push([data.ReleaseId, data.Name])
            })

            //assign collected data to model
            model.templateData.requirements.releases = arr;
         

            //assign values to model drop down data
            model.templateData.requirements.dropdowns['Version Number'] = arr;
            model.templateData.tasks.dropdowns['Version Number'] = model.templateData.requirements.releases;
         
         
            //call main template function
            getTemplate();

            //all user data loaded, call success notification
            google.script.run.success('User data loaded');
        }
    }

    function getTemplate(){

      //call server side template function
      google.script.run.withSuccessHandler(templateSuccess).withFailureHandler(errorUnknown).templateLoader(model.templateData);


            
            function templateSuccess(data) {
           
     
              model.templateData.isTemplateLoaded = true;
      
              //turn off ajax spinner if it's on
              hideLoadingSpinner();
            

              //enable the send to spira button
              $('#js--export').prop('disabled', false);
            }
             
    }
}


/*
 * 
 * ==============
 * ERROR HANDLING
 * ==============
 *
 * These call a popup using google server side code
 * most args are the HTTPResponse objects from the `withFailureHandler` promise
 *
 */

function errorPopUp(err, type) {
    google.script.run.error(type);
    hideLoadingSpinner();
    console.log(err);
}

function errorNetwork(err) {
    errorPopUp(err);
}

function errorImpExp(err) {
    errorPopUp(err, 'impExp');
}

function errorUnknown(err) {
    errorPopUp(err, 'unknown');
}

</script>



