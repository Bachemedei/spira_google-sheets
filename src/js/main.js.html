<script>
/*

JQuery click handlers for the main view

*/


//dev only
$('#dev--stubs').click(function (){
        $('#js--url').val('https://demo.spiraservice.net/christopher-abramson');
        $('#js--userName').val('administrator');
        $('#js--password').val('{2AE93998-6849-4132-80F6-3C9981A7CB96}');
})

$('#js--logIn').click(function() {
    //get user data from input fields and store in user data object
    model.userData.currentUser.url = $('#js--url').val();
    model.userData.currentUser.userName = $('#js--userName').val();
    model.userData.currentUser.api_key = btoa( '&api-key=' + encodeURIComponent($('#js--password').val()) );
    //run init function, starts building data model
    init();
});

$('#js--cancel').click(function() {
    //clear input field values
    $('#js--url, #js--userName, #js--password').val('');
});

$('#js--disconnect').click(function() {
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool) {
            //clear spreadsheet
            google.script.run.clearAll();

            //display log-in page
            $('#js--auth').toggleClass('open');

            //clear data model
            modelReset();

            //clear input fields
            $('#js--url, #js--userName, #js--password').val('');

            //disable template button
            $('#js--template').prop('disabled', true);

            //reset artifacts drop down
            $("#js--artifact option[value='Select an Artifact']").attr('selected', 'selected');
        }
    }
});

$('#js--template').click(function() {
    //get selected artifact and project
    let artifactName = $('#js--artifact option:selected').text();
    let projName = $('#js--project option:selected').text();
    //get and store project number for future calls
    let projNum = 0;
    for (let i = 0; i < model.userData.projects.length; i++) {
        model.userData.projects[i][1] === projName ? projNum = model.userData.projects[i][0] : null;
    }

    //store variables
    model.templateData.currentArtifactName = artifactName;
    model.templateData.currentProjectNumber = projNum;
    model.templateData.currentProjectName = projName;
    console.log(model.templateData.currentArtifactName);

    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    //if yes run template loader script
    function userChoice(bool) {
        bool ? google.script.run.withSuccessHandler(templateSuccess).withFailureHandler(errorUnk).templateLoader(model.templateData) : null;
    }

    function templateSuccess(data) {
        model.templateData.isTemplateLoaded = true;
        google.script.run.success('Template loaded successfully.');
    }
});

$('#js--import').click(function() {

    if (model.templateData.isTemplateLoaded) {
        google.script.run.withSuccessHandler(importSuccess).withFailureHandler(errorNetwork).importer(model.userData.currentUser);
    } else {
        google.script.run.noTemplate();
    }

    function importSuccess() {
        google.script.run.success('Data loaded successfully.');
    }

});

$('#js--export').click(function() {
    if (model.templateData.isTemplateLoaded) {
        // toggle on spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorImpExp).withSuccessHandler(exportSuccess).exporter(model);
    } else {
        google.script.run.noTemplate();
    }

    function exportSuccess(data) {
        //toggle off spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.exportSuccess(data[1]);
        console.log(data);
    }
});

$('#js--save').click(function() {
    if (model.templateData.isTemplateLoaded) {
        //toggle spinner on
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorUnk).withSuccessHandler(saveSuccess).save();
    } else {
        google.script.run.noTemplate();
    }

    function saveSuccess() {
        // toggle spinner off
        $('#js--loader').toggleClass('hidden');
        google.script.run.success('Sheet saved in new tab.');
    }
});

$('#js--clear').click(function() {
    //warn that data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        bool ? google.script.run.clearAll() : null;
    }

});


$('#js--data').click(function() {
    let proj = $('#js--project option:selected').val();
    let arti = $('#js--artifact option:selected').val();

    if (proj === 'Select a Project' || arti === 'Select an Artifact') {
        google.script.run.okWarn('You must select a Project and an Artifact.');
    } else {
        //warn the user data will be erased
        google.script.run.withSuccessHandler(userChoice).warn();

        function userChoice(bool) {
            if (bool){
                google.script.run.clearAll();
                model.userData.artifacts.map(function(artifact) {
                    if (artifact[1] === arti) {
                        model.templateData.currentArtifactName = arti;
                        model.templateData.currentArtifactId = artifact[0];
                    }
                });
                model.userData.projects.map(function(project) {
                    if (project[1] === proj) {
                        model.templateData.currentProjectName = proj;
                        model.templateData.currentProjectNumber = project[0];
                    }
                });

                updateData();
            }
        }
    }

});


$('#js--artifact').change(function(){
    let value = $('#js--artifact option:selected').val();
    console.log(value);
    });


var authHelp = false

$('.js--help').click(function() {
    $('#js--helpPage').toggleClass('open hidden')
    if ($('#js--auth').hasClass('open')) {
        authHelp = true;
        $('#js--auth').toggle('open');
    }
})

$('#js--helpClose').click(function() {
    $('#js--helpPage').toggleClass('open hidden');
    if (authHelp) {
        $('#js--auth').toggle('open');
    }
    authHelp = false;
})
</script>
