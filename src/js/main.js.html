<script>
/*

JQuery click handlers for the main view

*/


$('#js--logIn').click(function() {
    //get user data from input fields and store in user data object
    model.userData.currentUser.url = $('#js--url').val();
    model.userData.currentUser.userName = $('#js--userName').val();
    model.userData.currentUser.api_key = '&api-key=' + encodeURIComponent($('#js--password').val());
    //run init function, starts building data model
    init();
});

$('#js--cancel').click(function(){
    //clear input field values
    $('#js--url, #js--userName, #js--password').val('');
});

$('#js--disconnect').click(function(){
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool) {
            //clear spreadsheet
            google.script.run.clearAll();
            //display log-in page
            $('#js--auth').toggleClass('open');
            isTemplateLoaded = false;
            //clear model user values
            model.userData.currentUser.url = '';
            model.userData.currentUser.userName = '';
            model.userData.currentUser.API_KEY = '';
            //clear input fields
            $('#js--url, #js--userName, #js--password').val('');
        }
    }
});

$('#js--template').click(function(){
    //get selected artifact and project
    let artifactName = $('#js--artifact option:selected').text();
    let projName = $('#js--project option:selected').text();
        //get and store project number for future calls
    let projNum = 0;
    for (let i = 0; i < model.userData.projects.length; i++) {
        model.userData.projects[i][1] === projName ? projNum = model.userData.projects[i][0] : null;
    }

    //store variables
    model.templateData.currentArtifactName = artifactName;
    model.templateData.currentProjectNumber = projNum;
    model.templateData.currentProjectName = projName;
    console.log(model.templateData.currentArtifactName);

    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    //if yes run template loader script
    function userChoice(bool) {
        bool ? google.script.run.withSuccessHandler(templateSuccess).withFailureHandler(errorUnk).templateLoader(model.templateData) : null;
    }

    function templateSuccess(data) {
        model.templateData.isTemplateLoaded = true;
        google.script.run.success('Template loaded successfully.');
    }
});

$('#js--import').click(function(){

    if (model.templateData.isTemplateLoaded) {
        google.script.run.withSuccessHandler(importSuccess).withFailureHandler(errorNetwork).importer(model.userData.currentUser);
    } else {
        google.script.run.noTemplate();
    }

    function importSuccess() {
        google.script.run.success('Data loaded successfully.');
    }

});

$('#js--export').click(function(){
    if (model.templateData.isTemplateLoaded) {
        // toggle on spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorImpExp).withSuccessHandler(exportSuccess).exporter(model);
    } else {
        google.script.run.noTemplate();
    }

    function exportSuccess(data) {
        //toggle off spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.exportSuccess(data[1]);
        console.log(data);
    }
});

$('#js--save').click(function(){
    if (model.templateData.isTemplateLoaded) {
        //toggle spinner on
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorUnk).withSuccessHandler(saveSuccess).save();
    } else {
        google.script.run.noTemplate();
    }

    function saveSuccess() {
        // toggle spinner off
        $('#js--loader').toggleClass('hidden');
        google.script.run.success('Sheet saved in new tab.');
    }
});

$('#js--clear').click(function(){
    //warn that data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        bool ? google.script.run.clearAll() : null;
    }

});
//variables for select dropdown values
let prevProj,
    prevArti;

//on click this stores the current values of the dropdown menus for
//...recall if the user decides not to change the fields.
$('#js--artifact, #js--project').click(function(e){
    prevProj = $('#js--project option:selected');
    prevArti = $('#js--artifact option:selected');
})

$('#js--project').change(function(e) {
    //stores new dropdown value
    let newProj = e.target.value;
    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool){
            google.script.run.clearAll();
            model.userData.projects.map(function(proj){
                if (proj[1] === newProj){
                    model.templateData.currentProjectName = newProj;
                    model.templateData.currentProjectNumber = proj[0];
                }
            });
            updateData();
        } else {
            console.log(prevProj[0]);
            //sets the select dropdown back to the original value if the user says no
            prevProj[0].selected = true;
        }
    }

});

$('#js--artifact').change(function(e) {
     //TODO add change artifact functionality
});

var authHelp = false

$('.js--help').click(function(){
  $('#js--helpPage').toggleClass('open hidden')
 if ( $('#js--auth').hasClass('open') ) {
   authHelp = true;
   $('#js--auth').toggle('open');
 }
})

$('#js--helpClose').click(function(){
  $('#js--helpPage').toggleClass('open hidden');
  if (authHelp){
    $('#js--auth').toggle('open');
  }
  authHelp = false;
})


</script>
