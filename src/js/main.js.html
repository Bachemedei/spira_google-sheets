<script>
/*

Main client side scripts


*/

function errorPopUp(err, type){
  google.script.run.error(type);
   $('#js--loader').hasClass('hidden') ? null : $('#js--loader').toggleClass('hidden');
   console.log(err);
}

function errorNetwork(err){
  errorPopUp(err);
  }

function errorImpExp(err){
  errorPopUp(err, 'impExp');
  }

function errorUnk(err){
  errorPopUp(err, 'unk');
  }

function updateData() {
    //call google function to load user data
    //default project number hard coded to one on load
    google.script.run.withSuccessHandler(userSuccess).withFailureHandler(errorNetwork).getUsers(model.userData.currentUser, model.templateData.currentProjectNumber)

    function userSuccess(users) {
        //clear old values
        model.userData.projUsers = [];
        model.userData.projUserWNum = [];
        //map through user obj and assign names
        users.map(user => {
            let num = user.UserId;
            let first = user.FirstName;
            let last = user.LastName;
            let full = '';
                //check to see if middle names exist
            if (user.MiddleInitial) {
                let middle = user.MiddleInitial;
                full = first + ' ' + middle + ' ' + last;
            } else {
                full = first + ' ' + last;
            }
            model.userData.projUserWNum.push([num, full]);

            //populate user dropdowns
            model.templateData.requirements.dropdowns['Owner'] = model.userData.projUserWNum;
            model.templateData.requirements.dropdowns['Author'] = model.userData.projUserWNum;
        })
        getCustomFields();
    }


    function getCustomFields() {
        google.script.run.withSuccessHandler(customSuccess).withFailureHandler(errorNetwork)
            .getCustoms(model.userData.currentUser, model.templateData.currentProjectNumber, model.templateData.currentArtifactId);

        function customSuccess(data) {
            model.templateData.requirements.customFields = data;
            getComponentsValues();
        }
    }

    function getComponentsValues(){
        google.script.run.withSuccessHandler(componentSuccess).withFailureHandler(errorNetwork).getComponents(model.userData.currentUser, model.templateData.currentProjectNumber);

        function componentSuccess(data){
            var arr = [];
            data.map(function(data){
                arr.push([data.ComponentId, data.Name])
            })
            model.templateData.requirements.components = arr;

            model.templateData.requirements.dropdowns['Components'] = model.templateData.requirements.components;

            getReleasesValues();
        }
    }

    function getReleasesValues(){
        google.script.run.withSuccessHandler(releaseSuccess).withFailureHandler(errorNetwork).getReleases(model.userData.currentUser, model.templateData.currentProjectNumber);

        function releaseSuccess(data){
            var arr = [];
            console.log(data)
            data.map(function(data){
                arr.push([data.ReleaseId, data.FullName])
            })

            model.templateData.requirements.releases = arr;

            model.templateData.requirements.dropdowns['Version Number'] = model.templateData.requirements.releases;

            console.log(model);

            //turn off ajax spinner if it's on
            $('#js--loader').hasClass('hidden') ? null : $('#js--loader').toggleClass('hidden');
            //success notification
            google.script.run.success('User data loaded');
        }
    }
}

function init() {
    //turn on ajax spinner
    $('#js--loader').toggleClass('hidden');

    google.script.run.withSuccessHandler(projectSuccess).withFailureHandler(errorNetwork).getProjects(model.userData.currentUser);

    function projectSuccess(projects) {
        //clear projects user data
        model.userData.projects = [];
        //store project data
        projects.map(function(project) {
            let projArr = [project.ProjectId, project.Name];
            model.userData.projects.push(projArr);
        });
        //get userdata and customfields....needs a better name
        updateData();
        //populate fields
        populateFields();
    }

    function populateFields() {
        //clear project drop down in case of reload
        $('#js--project').html('');
        //populate projects drop down
        model.userData.projects.map(proj => {
                let option = $('<option></option>');
                option.attr('value', proj[1]);
                option.text(proj[1]);
                $('#js--project').append(option);
            })
            //close auth window if open
        $('#js--auth').hasClass('open') ? $('#js--auth').removeClass('open') : null;

        google.script.run.success('Projects loaded');
    }
}

$('#js--logIn').click(function() {
    //get user data from input fields and store in user data object
    model.userData.currentUser.url = $('#js--url').val();
    model.userData.currentUser.userName = $('#js--userName').val();
    model.userData.currentUser.api_key = '&api-key=' + encodeURIComponent($('#js--password').val());
    //run init function, starts building data model
    init();
});

$('#js--cancel').click(function(){
    //clear input field values
    $('#js--url, #js--userName, #js--password').val('');
});

$('#js--disconnect').click(function(){
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool) {
            //clear spreadsheet
            google.script.run.clearAll();
            //display log-in page
            $('#js--auth').toggleClass('open');
            isTemplateLoaded = false;
            //clear model user values
            model.userData.currentUser.url = '';
            model.userData.currentUser.userName = '';
            model.userData.currentUser.API_KEY = '';
            //clear input fields
            $('#js--url, #js--userName, #js--password').val('');
        }
    }
});

$('#js--template').click(function(){
    //get selected artifact and project
    let artifactName = $('#js--artifact option:selected').text();
    let projName = $('#js--project option:selected').text();
        //get and store project number for future calls
    let projNum = 0;
    for (let i = 0; i < model.userData.projects.length; i++) {
        model.userData.projects[i][1] === projName ? projNum = model.userData.projects[i][0] : null;
    }

    //store variables
    model.templateData.currentArtifactName = artifactName;
    model.templateData.currentProjectNumber = projNum;
    model.templateData.currentProjectName = projName;
    console.log(model.templateData.currentArtifactName);

    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    //if yes run template loader script
    function userChoice(bool) {
        bool ? google.script.run.withSuccessHandler(templateSuccess).withFailureHandler(errorUnk).templateLoader(model.templateData) : null;
    }

    function templateSuccess(data) {
        model.templateData.isTemplateLoaded = true;
        google.script.run.success('Template loaded successfully.');
    }
});

$('#js--import').click(function(){

    if (model.templateData.isTemplateLoaded) {
        google.script.run.withSuccessHandler(importSuccess).withFailureHandler(errorNetwork).importer(model.userData.currentUser);
    } else {
        google.script.run.noTemplate();
    }

    function importSuccess() {
        google.script.run.success('Data loaded successfully.');
    }

});

$('#js--export').click(function(){
    if (model.templateData.isTemplateLoaded) {
        // toggle on spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorImpExp).withSuccessHandler(exportSuccess).exporter(model);
    } else {
        google.script.run.noTemplate();
    }

    function exportSuccess(data) {
        //toggle off spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.exportSuccess(data[1]);
        console.log(data);
    }
});

$('#js--save').click(function(){
    if (model.templateData.isTemplateLoaded) {
        //toggle spinner on
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorUnk).withSuccessHandler(saveSuccess).save();
    } else {
        google.script.run.noTemplate();
    }

    function saveSuccess() {
        // toggle spinner off
        $('#js--loader').toggleClass('hidden');
        google.script.run.success('Sheet saved in new tab.');
    }
});

$('#js--clear').click(function(){
    //warn that data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        bool ? google.script.run.clearAll() : null;
    }

});
//variables for select dropdown values
let prevProj,
    prevArti;

//on click this stores the current values of the dropdown menus for
//...recall if the user decides not to change the fields.
$('#js--artifact, #js--project').click(function(e){
    prevProj = $('#js--project option:selected');
    prevArti = $('#js--artifact option:selected');
})

$('#js--project').change(function(e) {
    //stores new dropdown value
    let newProj = e.target.value;
    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool){
            google.script.run.clearAll();
            model.userData.projects.map(function(proj){
                if (proj[1] === newProj){
                    model.templateData.currentProjectName = newProj;
                    model.templateData.currentProjectNumber = proj[0];
                }
            });
            updateData();
        } else {
            console.log(prevProj[0]);
            //sets the select dropdown back to the original value if the user says no
            prevProj[0].selected = true;
        }
    }

});

$('#js--artifact').change(function(e) {
     //TODO add change artifact functionality
});

var authHelp = false

$('.js--help').click(function(){
  $('#js--helpPage').toggleClass('open hidden')
 if ( $('#js--auth').hasClass('open') ) {
   authHelp = true;
   $('#js--auth').toggle('open');
 }
})

$('#js--helpClose').click(function(){
  $('#js--helpPage').toggleClass('open hidden');
  if (authHelp){
    $('#js--auth').toggle('open');
  }
  authHelp = false;
})


</script>
