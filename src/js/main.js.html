<script>
function errorNetwork(err) {
    google.script.run.error();
    $('#js--loader').toggleClass('hidden');
    console.log(err);
}

function errorImpExp(err) {
    google.script.run.error('impExp');
    $('#js--loader').toggleClass('hidden');
    console.log(err);
}

function errorUnk(err) {
    google.script.run.error('unk');
    $('#js--loader').toggleClass('hidden');
    console.log(err);
}

function updateData() {
    //call google function to load user data
    //default project number hard coded to one on load
    google.script.run.withSuccessHandler(userSuccess).withFailureHandler(errorNetwork).getUsers(model.userData.currentUser, model.templateData.currentProjectNumber)

    function userSuccess(users) {
        //map through user obj and assign names
        users.map(user => {
            let num = user.UserId;
            let first = user.FirstName;
            let last = user.LastName;
            let full = ''
                //check to see if middle names exist
            if (user.MiddleInitial) {
                let middle = user.MiddleInitial
                full = `${first} ${middle} ${last}`
            } else {
                full = `${first} ${last}`
            }
            model.userData.projUsers.push(full)
            model.userData.projUserWNum.push([full, num])
            //populate user dropdowns
            model.templateData.requirements.dropdowns['Owner'] = model.userData.projUsers;
            model.templateData.requirements.dropdowns['Author'] = model.userData.projUsers;
        })
        getCustomFields();
    }


    function getCustomFields() {
        google.script.run.withSuccessHandler(customSuccess).withFailureHandler(errorNetwork)
            .getCustoms(model.userData.currentUser, model.templateData.currentProjectNumber, model.templateData.currentArtifactId)

        function customSuccess(data) {
            model.templateData.requirements.customFields = data;
            //turn off ajax spinner if it's on
            $('#js--loader').hasClass('hidden') ? null : $('#js--loader').toggleClass('hidden')
            //success notification
            google.script.run.success('User data loaded');
        }
    }
}

function init() {
    //turn on ajax spinner
    $('#js--loader').toggleClass('hidden');

    google.script.run.withSuccessHandler(projectSuccess).withFailureHandler(errorNetwork).getProjects(model.userData.currentUser)

    function projectSuccess(projects) {
        //clear projects user data
        model.userData.projects = []
        //store project data
        projects.map(function(project) {
            let projArr = [project.ProjectId, project.Name]
            model.userData.projects.push(projArr)
        });
        //get userdata and customfields....needs a better name
        updateData();
        //populate fields
        populateFields();
    }

    function populateFields() {
        //clear project drop down in case of reload
        $('#js--project').html('');
        //populate projects drop down
        model.userData.projects.map(proj => {
                let option = $('<option></option>');
                option.attr('value', proj[1]);
                option.text(proj[1]);
                $('#js--project').append(option);
            })
            //close auth window if open
        $('#js--auth').hasClass('open') ? $('#js--auth').removeClass('open') : null;

        google.script.run.success('Projects loaded');
    }
}

$('#js--logIn').click(() => {
    //get user data from input fields and store in user data object
    model.userData.currentUser.url = $('#js--url').val();
    model.userData.currentUser.userName = $('#js--userName').val();
    model.userData.currentUser.API_KEY = encodeURIComponent($('#js--password').val())
    init();
});

$('#js--cancel').click(() => {
    //clear field values
    $('#js--url').val('');
    $('#js--userName').val('');
    $('#js--password').val('');
});

$('#js--connect').click(() => console.log('test'));

$('#js--disconnect').click(() => {
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool) {
            //clear spreadsheet
            google.script.run.clearAll();
            $('#js--auth').toggleClass('open');
            isTemplateLoaded = false;
            model.userData.currentUser.url = '';
            model.userData.currentUser.userName = '';
            model.userData.currentUser.API_KEY = '';
        }
    }
});

$('#js--options').click(() => console.log('test'));

$('#js--template').click(() => {
    //get selected artifact and project
    let artifactName = $('#js--artifact option:selected').text();
    let projName = $('#js--project option:selected').text()
        //get and store project number for future calls
    let projNum = 0
    for (let i = 0; i < model.userData.projects.length; i++) {
        model.userData.projects[i][1] === projName ? projNum = model.userData.projects[i][0] : null;
    }

    //store variables
    model.templateData.currentArtifactName = artifactName;
    model.templateData.currentProjectNumber = projNum;
    model.templateData.currentProjectName = projName;

    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    //if yes run template loader script
    function userChoice(bool) {
        bool ? google.script.run.withSuccessHandler(templateSuccess).withFailureHandler(errorUnk).templateLoader(model.templateData) : null
    }

    function templateSuccess() {
        model.templateData.isTemplateLoaded = true;
        google.script.run.success('Template loaded successfully.')
        console.log(model.templateData)
    }
});

$('#js--import').click(() => {

    if (model.templateData.isTemplateLoaded) {
        google.script.run.withSuccessHandler(importSuccess).withFailureHandler(errorNetwork).importer(model.userData.currentUser)
    } else {
        google.script.run.noTemplate()
    }

    function importSuccess() {
        google.script.run.success('Data loaded successfully.')
    }

});

$('#js--export').click(() => {
    if (model.templateData.isTemplateLoaded) {
        // toggle on spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorImpExp).withSuccessHandler(exportSuccess).exporter(model)
    } else {
        google.script.run.noTemplate()
    }

    function exportSuccess(data) {
        //toggle off spinner
        $('#js--loader').toggleClass('hidden');
        google.script.run.success('Data exported successfully.')
        console.log(data);
    }
});

$('#js--save').click(() => {
    if (model.templateData.isTemplateLoaded) {
        //toggle spinner on
        $('#js--loader').toggleClass('hidden');
        google.script.run.withFailureHandler(errorUnk).withSuccessHandler(saveSuccess).save();
    } else {
        google.script.run.noTemplate();
    }

    function saveSuccess() {
        // toggle spinner off
        $('#js--loader').toggleClass('hidden');
        google.script.run.success('Sheet saved in new tab.')
    }
});

$('#js--clear').click(() => {
    //warn that data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        bool ? google.script.run.clearAll() : null;
    }

});
//variables for select dropdown values
let prevProj,
    prevArti;

//on click this stores the current values of the dropdown menus for
//...recall if the user decides not to change the fields.
$('#js--artifact, #js--project').click(function(e){
    prevProj = $('#js--project option:selected')
    prevArti = $('#js--artifact option:selected')
})

$('#js--project').change(function(e) {
    //stores new dropdown value
    let newProj = e.target.value;
    //warn the user data will be erased
    google.script.run.withSuccessHandler(userChoice).warn();

    function userChoice(bool) {
        if (bool){
            model.userData.projects.map(function(proj){
                if (proj[1] === newProj){
                    model.templateData.currentProjectName = newProj;
                    model.templateData.currentProjectNumber = proj[0];
                }
            });
            console.log(model.templateData)
            updateData();
        } else {
            //sets the select dropdown back to the original value if the user says no
            prevProj[0].selected = true;
        }
    }

});

$('#js--artifact').change(function(e) {
     //TODO add change artifact functionality
});
</script>
