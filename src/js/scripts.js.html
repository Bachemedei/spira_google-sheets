<script>
/*
These scripts build the model for the selected artifact

Error popups are also located here
*/

function updateData() {
    //call google function to load user data
    //default project number hard coded to one on load
    google.script.run.withSuccessHandler(userSuccess).withFailureHandler(errorNetwork).getUsers(model.userData.currentUser, model.templateData.currentProjectNumber)

    function userSuccess(users) {
        //clear old values
        model.userData.projUserWNum = [];
        //map through user obj and assign names
        users.map(user => {
            let num = user.UserId;
            let first = user.FirstName;
            let last = user.LastName;
            let full = '';
            //check to see if middle names exist
            if (user.MiddleInitial) {
                let middle = user.MiddleInitial;
                full = first + ' ' + middle + ' ' + last;
            } else {
                full = first + ' ' + last;
            }
            model.userData.projUserWNum.push([num, full]);

            //populate user dropdowns
            model.templateData.requirements.dropdowns['Owner'] = model.userData.projUserWNum;
            model.templateData.requirements.dropdowns['Author'] = model.userData.projUserWNum;
        })
        getCustomFields();
    }


    function getCustomFields() {
        google.script.run.withSuccessHandler(customSuccess).withFailureHandler(errorNetwork)
            .getCustoms(model.userData.currentUser, model.templateData.currentProjectNumber, model.templateData.currentArtifactId);

        function customSuccess(data) {
            model.templateData.requirements.customFields = data;
            getComponentsValues();
        }
    }

    function getComponentsValues() {
        google.script.run.withSuccessHandler(componentSuccess).withFailureHandler(errorNetwork).getComponents(model.userData.currentUser, model.templateData.currentProjectNumber);

        function componentSuccess(data) {
            var arr = [];
            data.map(function(data) {
                arr.push([data.ComponentId, data.Name])
            })
            model.templateData.requirements.components = arr;

            model.templateData.requirements.dropdowns['Components'] = model.templateData.requirements.components;

            getReleasesValues();
        }
    }

    function getReleasesValues() {
        google.script.run.withSuccessHandler(releaseSuccess).withFailureHandler(errorNetwork).getReleases(model.userData.currentUser, model.templateData.currentProjectNumber);

        function releaseSuccess(data) {
            var arr = [];
            console.log(data)
            data.map(function(data) {
                arr.push([data.ReleaseId, data.FullName])
            })

            model.templateData.requirements.releases = arr;

            model.templateData.requirements.dropdowns['Version Number'] = model.templateData.requirements.releases;

            console.log(model);

            //turn off ajax spinner if it's on
            $('#js--loader').hasClass('hidden') ? null : $('#js--loader').toggleClass('hidden');
            //success notification
            google.script.run.success('User data loaded');
        }
    }
}

function init() {
    //turn on ajax spinner
    $('#js--loader').toggleClass('hidden');

    google.script.run.withSuccessHandler(projectSuccess).withFailureHandler(errorNetwork).getProjects(model.userData.currentUser);

    function projectSuccess(projects) {
        //clear projects user data
        model.userData.projects = [];
        //store project data
        projects.map(function(project) {
            let projArr = [project.ProjectId, project.Name];
            model.userData.projects.push(projArr);
        });
        //get userdata and customfields....needs a better name
        updateData();
        //populate fields
        populateFields();
    }

    function populateFields() {
        //clear project drop down in case of reload
        $('#js--project').html('');
        //populate projects drop down
        model.userData.projects.map(proj => {
                let option = $('<option></option>');
                option.attr('value', proj[1]);
                option.text(proj[1]);
                $('#js--project').append(option);
            })
            //close auth window if open
        $('#js--auth').hasClass('open') ? $('#js--auth').removeClass('open') : null;

        google.script.run.success('Projects loaded');
    }
}

function errorPopUp(err, type) {
    google.script.run.error(type);
    $('#js--loader').hasClass('hidden') ? null : $('#js--loader').toggleClass('hidden');
    console.log(err);
}

function errorNetwork(err) {
    errorPopUp(err);
}

function errorImpExp(err) {
    errorPopUp(err, 'impExp');
}

function errorUnk(err) {
    errorPopUp(err, 'unk');
}
</script>
